(function($){"use strict";$(document).ready(function(){if($.fn.lsvrTownpressDirectoryMapLeaflet&&'object'===typeof L){$('.lsvr_listing-map--leaflet #lsvr_listing-map__canvas').each(function(){$(this).lsvrTownpressDirectoryMapLeaflet()})}});if(!$.fn.lsvrTownpressDirectoryMapLeaflet){var lsvrTownpressDirectoryMapLeafletAjaxRequest;var lsvrTownpressDirectoryMapLeafletMethods={init:function(){var $this=$(this),zoom=$this.data('zoom')?$this.data('zoom'):17,enableMouseWheel=$this.data('mousewheel')&&true===String($this.data('mousewheel'))?true:false,elementId=$this.attr('id'),query=$this.data('query')?$this.data('query'):{};var mapOptions={zoom:zoom,scrollWheelZoom:enableMouseWheel};var map=L.map(elementId,mapOptions);$this.data('map',map);$this.lsvrTownpressDirectoryMapLeaflet('ajaxRequest',query)},ajaxRequest:function(query){if(typeof query!='undefined'){var $this=this;if(typeof lsvr_townpress_ajax_directory_map_var!=='undefined'){if('undefined'!==typeof lsvrTownpressDirectoryMapLeafletAjaxRequest){lsvrTownpressDirectoryMapLeafletAjaxRequest.abort()}lsvrTownpressDirectoryMapLeafletAjaxRequest=jQuery.ajax({type:'post',dataType:'JSON',url:lsvr_townpress_ajax_directory_map_var.url,data:{action:'lsvr-townpress-ajax-directory-map',nonce:encodeURIComponent(lsvr_townpress_ajax_directory_map_var.nonce),query:query},success:function(response){$this.lsvrTownpressDirectoryMapLeaflet('refresh',response)}})}}},refresh:function(response){if(this.data('map')){var $this=this,map=$this.data('map'),zoom=$this.data('zoom'),mapProvider=$this.data('map-provider')?$this.data('map-provider'):'osm';var responseLocations=response.hasOwnProperty('locations')?response.locations:false,responseLabels=response.hasOwnProperty('labels')?response.labels:false;if(false!==responseLocations&&responseLocations.length>0){if('mapbox'===mapProvider){var apiKey=typeof lsvr_townpress_mapbox_api_key!=='undefined'?lsvr_townpress_mapbox_api_key:false;if(false!==apiKey){L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token='+apiKey,{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:'mapbox/streets-v11',tileSize:512,zoomOffset:-1,accessToken:apiKey}).addTo(map)}}else if('osm'===mapProvider){L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:['a','b','c']}).addTo(map)}var markerGroup=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:'<div class="lsvr_listing-map__marker-cluster"><div class="lsvr_listing-map__marker-cluster-inner">'+cluster.getChildCount()+'</div></div>'})},showCoverageOnHover:false});for(var i=0;i<responseLocations.length;i+=1){if(responseLocations[i].hasOwnProperty('latitude')&&responseLocations[i].hasOwnProperty('longitude')){var boxHtml='';if(responseLocations[i].hasOwnProperty('thumburl')){boxHtml+='<div class="lsvr_listing-map__infobox lsvr_listing-map__infobox--has-thumb">'}else{boxHtml+='<div class="lsvr_listing-map__infobox">'}boxHtml+='<div class="lsvr_listing-map__infobox-inner">';if(responseLocations[i].hasOwnProperty('thumburl')&&responseLocations[i].hasOwnProperty('permalink')){boxHtml+='<a href="'+responseLocations[i].permalink+'" class="lsvr_listing-map__infobox-thumb" style="background-image: url( \''+responseLocations[i].thumburl+'\' ); "></a>'}if(responseLocations[i].hasOwnProperty('category')&&'undefined'!==typeof responseLabels.marker_infowindow_cat_prefix){var categoryHtml='';for(var j=0;j<responseLocations[i].category.length;j+=1){if(responseLocations[i].category[j].hasOwnProperty('name')&&responseLocations[i].category[j].hasOwnProperty('url')){categoryHtml+='<a href="'+responseLocations[i].category[j].url+'" class="lsvr_listing-map__infobox-category-link">'+responseLocations[i].category[j].name+'</a>';if(j<responseLocations[i].category.length-1){categoryHtml+=', '}}}boxHtml+='<p class="lsvr_listing-map__infobox-category">'+responseLabels.marker_infowindow_cat_prefix.replace('%s',categoryHtml)+'</p>'}if(responseLocations[i].hasOwnProperty('title')&&responseLocations[i].hasOwnProperty('permalink')){boxHtml+='<h4 class="lsvr_listing-map__infobox-title">';boxHtml+='<a href="'+responseLocations[i].permalink+'" class="lsvr_listing-map__infobox-title-link">'+responseLocations[i].title;boxHtml+='</a></h4>'}if(responseLocations[i].hasOwnProperty('address')){boxHtml+='<p class="lsvr_listing-map__infobox-address">'+responseLocations[i].address.replace(/(?:\r\n|\r|\n)/g,'<br>')+'</p>'}if('undefined'!==typeof responseLabels.marker_infowindow_more_link&&responseLocations[i].hasOwnProperty('permalink')){boxHtml+='<p class="lsvr_listing-map__infobox-more"><a href="'+responseLocations[i].permalink+'" class="lsvr_listing-map__infobox-more-link">'+responseLabels.marker_infowindow_more_link+'</a></p>'}boxHtml+='</div></div>';if(responseLocations[i].hasOwnProperty('thumburl')){markerGroup.addLayer(L.marker([responseLocations[i].latitude,responseLocations[i].longitude],{icon:L.divIcon({popupAnchor:[0,-50],iconAnchor:[15,40],className:'lsvr_listing-map__marker-wrapper',html:'<div class="lsvr_listing-map__marker lsvr_listing-map__marker--has-thumb lsvr_listing-map__marker--id-'+responseLocations[i].id+'"><div class="lsvr_listing-map__marker-inner lsvr_listing-map__marker-inner--has-thumb" style="background-image: url(\''+responseLocations[i].thumburl+'\');"></div></div>'})}).bindPopup(boxHtml))}else{markerGroup.addLayer(L.marker([responseLocations[i].latitude,responseLocations[i].longitude],{icon:L.divIcon({popupAnchor:[0,-40],iconAnchor:[15,40],className:'lsvr_listing-map__marker-wrapper',html:'<div class="class="lsvr_listing-map__marker lsvr_listing-map__marker--id-'+responseLocations[i].id+'"><div class="lsvr_listing-map__marker-inner"></div></div>'})}).bindPopup(boxHtml))}}}map.addLayer(markerGroup).fitBounds(markerGroup.getBounds());if(1===responseLocations.length){map.setZoom(zoom)}$this.removeClass('lsvr_listing-map__canvas--loading');$this.parent().find('.lsvr_listing-map__spinner').remove()}else{$this.parent().hide()}}}};$.fn.lsvrTownpressDirectoryMapLeaflet=function(method){if(lsvrTownpressDirectoryMapLeafletMethods[method]){return lsvrTownpressDirectoryMapLeafletMethods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{return lsvrTownpressDirectoryMapLeafletMethods.init.apply(this,arguments)}}}})(jQuery);